Starting a Fresh FOGGIE Run from Initial Conditions
===================================================

This describes the steps necessary to start a fresh zoom-in simulation
with all the bells and whistles we use in the FOGGIE production runs.

Initial Conditions
------------------

The initial conditions first need to be generated by MUSIC (see other
documentation for that). This produces one of each of the following files
for each refinement level N (typically 0 through 4):

 * GridDensity.N
 * GridVelocities_x.N
 * GridVelocities_y.N
 * GridVelocities_z.N
 * ParticleDisplacements_x.N
 * ParticleDisplacements_y.N
 * ParticleDisplacements_z.N
 * ParticleVelocities_x.N
 * ParticleVelocities_y.N
 * ParticleVelocities_z.N
 * RefinementMask.N

In addition to these initial condition files, you also need an Enzo
parameter file. 

Initial Parameter File
----------------------

Here is the basic parameter file to start with. Note that the parameters
``CosmologySimulationGridDimension``, ``CosmologySimulationGridLeftEdge``,
and ``CosmologySimulationGridRightEdge`` (one for each refinement level)
will be set by the particular halo of interest that will later be zoomed
in on, so make sure to set these manually. All other parameters should be
as listed here:

::

    ProblemType                = 30      // cosmology simulation
    TopGridRank                = 3
    TopGridDimensions          = 256 256 256
    TopGridGravityBoundary     = 0       // Periodic BC for gravity
    LeftFaceBoundaryCondition  = 3 3 3   // same for fluid
    RightFaceBoundaryCondition = 3 3 3
    SelfGravity                = 1       // gravity on
    PotentialIterations        = 4
    ComputePotential           = 1 
    WritePotential             = 1 

    CosmologySimulationOmegaBaryonNow        = 0.0461
    CosmologySimulationOmegaCDMNow           = 0.2389
    CosmologySimulationDensityName           = GridDensity
    CosmologySimulationVelocity1Name         = GridVelocities_x
    CosmologySimulationVelocity2Name         = GridVelocities_y
    CosmologySimulationVelocity3Name         = GridVelocities_z
    CosmologySimulationParticleVelocity1Name = ParticleVelocities_x
    CosmologySimulationParticleVelocity2Name = ParticleVelocities_y
    CosmologySimulationParticleVelocity3Name = ParticleVelocities_z
    CosmologySimulationParticleDisplacement1Name = ParticleDisplacements_x
    CosmologySimulationParticleDisplacement2Name = ParticleDisplacements_y
    CosmologySimulationParticleDisplacement3Name = ParticleDisplacements_z
    CosmologySimulationParticleTypeName          = RefinementMask
    CosmologySimulationCalculatePositions    = 1
    CosmologySimulationNumberOfInitialGrids  = 5
    CosmologySimulationGridDimension[1]      =               30               42               36
    CosmologySimulationGridLeftEdge[1]       =          0.46875       0.45703125       0.46484375
    CosmologySimulationGridRightEdge[1]      =       0.52734375        0.5390625       0.53515625
    CosmologySimulationGridLevel[1]          = 1
    CosmologySimulationGridDimension[2]      =               42               68               52
    CosmologySimulationGridLeftEdge[2]       =      0.478515625       0.46484375      0.474609375
    CosmologySimulationGridRightEdge[2]      =       0.51953125          0.53125      0.525390625
    CosmologySimulationGridLevel[2]          = 2
    CosmologySimulationGridDimension[3]      =               68              116               84
    CosmologySimulationGridLeftEdge[3]       =      0.482421875     0.4697265625     0.4794921875
    CosmologySimulationGridRightEdge[3]      =         0.515625     0.5263671875     0.5205078125
    CosmologySimulationGridLevel[3]          = 3
    CosmologySimulationGridDimension[4]      =              120              214              152
    CosmologySimulationGridLeftEdge[4]       =         0.484375     0.4716796875     0.4814453125
    CosmologySimulationGridRightEdge[4]      =      0.513671875     0.5239257812     0.5185546875
    CosmologySimulationGridLevel[4]          = 4

    CosmologySimulationUseMetallicityField = 1

    ComovingCoordinates        = 1       // Expansion ON
    CosmologyOmegaMatterNow    = 0.285
    CosmologyOmegaDarkMatterNow = 0.2389
    CosmologyOmegaLambdaNow    = 0.715
    CosmologyHubbleConstantNow = 0.695
    CosmologyComovingBoxSize   = 100.0    // in Mpc/h = 100 Mpc comoving
    CosmologyMaxExpansionRate  = 0.01   // maximum allowed delta(a)/a
    CosmologyInitialRedshift   = 99.0
    CosmologyFinalRedshift 	   = 15.0    // stop at z = 15 to turn on self-shielding
    GravitationalConstant      = 1.0       // this must be true for cosmology

    DataDumpDir      = DD
    DataDumpName     = DD
    RedshiftDumpName = RD
    RedshiftDumpDir  = RD

    dtDataDump 	 = 5.0

    OutputCoolingTime                        = 1
    OutputTemperature                        = 1

    CosmologyOutputRedshift[0]               = 99.0
    CosmologyOutputRedshift[1]               = 50.0
    CosmologyOutputRedshift[2]               = 40.0
    CosmologyOutputRedshift[3]               = 30.0
    CosmologyOutputRedshift[4]               = 25.0
    CosmologyOutputRedshift[5]               = 20.0
    CosmologyOutputRedshift[6]               = 15.0 
    CosmologyOutputRedshift[7]               = 12.5
    CosmologyOutputRedshift[8]               = 10.0
    CosmologyOutputRedshift[9]               = 9.0
    CosmologyOutputRedshift[10]               = 8.0
    CosmologyOutputRedshift[11]               = 7.0
    CosmologyOutputRedshift[12]               = 6.0
    CosmologyOutputRedshift[13]               = 5.0
    CosmologyOutputRedshift[14]               = 4.0
    CosmologyOutputRedshift[15]               = 3.5
    CosmologyOutputRedshift[16]               = 3.0
    CosmologyOutputRedshift[17]               = 2.75
    CosmologyOutputRedshift[18]               = 2.5
    CosmologyOutputRedshift[19]               = 2.25
    CosmologyOutputRedshift[20]               = 2.0
    CosmologyOutputRedshift[21]               = 1.75
    CosmologyOutputRedshift[22]               = 1.5
    CosmologyOutputRedshift[23]               = 1.4
    CosmologyOutputRedshift[24]               = 1.3
    CosmologyOutputRedshift[25]               = 1.2
    CosmologyOutputRedshift[26]               = 1.1
    CosmologyOutputRedshift[27]               = 1.0
    CosmologyOutputRedshift[28]               = 0.9
    CosmologyOutputRedshift[29]               = 0.8
    CosmologyOutputRedshift[30]               = 0.7
    CosmologyOutputRedshift[31]               = 0.6
    CosmologyOutputRedshift[32]               = 0.5
    CosmologyOutputRedshift[33]               = 0.45
    CosmologyOutputRedshift[34]               = 0.4
    CosmologyOutputRedshift[35]               = 0.35
    CosmologyOutputRedshift[36]               = 0.3
    CosmologyOutputRedshift[37]               = 0.25
    CosmologyOutputRedshift[38]               = 0.2
    CosmologyOutputRedshift[39]               = 0.15
    CosmologyOutputRedshift[40]               = 0.1
    CosmologyOutputRedshift[41]               = 0.05
    CosmologyOutputRedshift[42]               = 0.0

    StopCycle        = 100000
    StopCPUTime      = 3600000

    HydroMethod                     = 0       // PPM
    RiemannSolver                   = 4       // HLLC
    Gamma                           = 1.6667
    PPMDiffusionParameter           = 0       // diffusion off
    DualEnergyFormalism             = 1       // use total & internal energy
    InterpolationMethod             = 1       // SecondOrderA
    ReconstructionMethod            = 1 // PPM
    RiemannSolverFallback           = 1 // HLL if there is a dnu<=0
    FluxCorrection                  = 1
    ConservativeInterpolation       = 0
    CourantSafetyNumber             = 0.4
    ParticleCourantSafetyNumber     = 0.8

    StaticHierarchy                = 0    // dynamic hierarchy
    MaximumRefinementLevel         = 11   // 11 = 190/h comoving pc
    MaximumGravityRefinementLevel  = 11
    MaximumParticleRefinementLevel = 11
    RefineBy                       = 2    // refinement factor
    CellFlaggingMethod             = 2 4 8  // use DM mass and must refine particles
    MinimumEfficiency              = 0.4  // fraction efficiency
    MinimumOverDensityForRefinement = 0.001953125  0.001953125 // times the initial density refers to top grid: devide by 8 for each additional level
    MinimumMassForRefinementLevelExponent = 0.0 0.0
    MustRefineParticlesCreateParticles = 3
    MustRefineParticlesRefineToLevel   = 4

    NumberOfBufferZones                      = 2

    RebuildHierarchyCycleSkip[0] = 2
    RebuildHierarchyCycleSkip[1] = 2
    RebuildHierarchyCycleSkip[2] = 2
    RebuildHierarchyCycleSkip[3] = 2
    RebuildHierarchyCycleSkip[4] = 2
    RebuildHierarchyCycleSkip[5] = 2
    RebuildHierarchyCycleSkip[6] = 2
    RebuildHierarchyCycleSkip[7] = 2
    RebuildHierarchyCycleSkip[8] = 2
    RebuildHierarchyCycleSkip[9] = 2
    RebuildHierarchyCycleSkip[10] = 2

    RadiativeCooling                         = 1
    use_grackle                              = 1
    MultiSpecies                             = 2
    MetalCooling                             = 1
    UVbackground                             = 1
    grackle_data_file                        = /nobackup/clochhaa/grackle_install/grackle/input/CloudyData_UVB=HM2012.h5 // change to your own grackle install path
    CMBTemperatureFloor                      = 1

    StarParticleCreation                     = 2048
    StarParticleFeedback                     = 64
    WriteFeedbackLogFiles                    = 1
    MomentumCancellationToThermal            = 1
    MomentumMultiplier                       = 1.0
    StarMakerOverDensityThreshold            = 1.0e+4
    StarMakerMinimumMass                     = 100.
    StarMakerMinimumDynamicalTime            = 1.0e+6
    StarMakerMassEfficiency                  = 0.2
    StarMassEjectionFraction                 = 0.25
    StarMetalYield                           = 0.025
    StarEnergyToThermalFeedback              = 1e-5
    StarFeedbackDistRadius                   = 1
    StarFeedbackDistCellStep                 = 3

    H2StarMakerEfficiency              = 0.02
    H2StarMakerNumberDensityThreshold  = 0
    H2StarMakerMinimumMass             = 1
    H2StarMakerMinimumH2FractionForStarFormation = 1e-09
    H2StarMakerStochastic              = 0
    H2StarMakerUseSobolevColumn        = 1
    H2StarMakerSigmaOverR              = 0.0333333
    H2StarMakerAssumeColdWarmPressureBalance = 1
    H2StarMakerH2DissociationFlux_MW   = 1
    H2StarMakerH2FloorInColdGas        = 0
    H2StarMakerColdGasTemperature      = 10000
    H2StarMakerUseLocalDensityMax      = 0
    H2StarMakerWriteStarLogFiles       = 1

    LoadBalancing               = 1
    ResetLoadBalancing     = 0
    SubgridSizeAutoAdjust       = 1
    LoadBalancingMinLevel  = 0
    LoadBalancingMaxLevel  = 50
    LoadBalancingCycleSkip = 2
    OptimalSubgridsPerProcessor = 16
    UnigridTranspose            = 2

    PartitionNestedGrids = 1
    ParallelRootGridIO   = 1
    ParallelParticleIO   = 1

Submit this to run on the devel queue because it will only take 10-20 minutes
to reach z = 15.

Turning on Self-Shielding
-------------------------

Once the simulation reaches z = 15, it's time to turn on self-shielding.
The last output snapshot should be RD0006. Here are the parameters you need
to change in the RD0006/RD0006 parameter file:

::

    CosmologyFinalRedshift = 6          // stop at z = 6 to turn on track box
    StarFormationOncePerRootGridTimeStep  = 1
    H2StarMakerH2FractionMethod        = 1
    self_shielding_method       = 3
    H2_self_shielding           = 1
    grackle_data_file           = /nobackup/clochhaa/grackle_install/grackle/input/CloudyData_UVB=HM2012_shielded.h5  // use the path to your own grackle install. Note this time it is the shielded file

With those changes made, you can now submit it to run again, and this time
it will stop at z = 6. This will probably take an hour or two.

Turning on the Track box
------------------------

The last output should be RD0012 (z = 6). In the RD0012/RD0012 parameter
file, change these parameters:

::

    CellFlaggingMethod             = 2 4 7 8 12 -99999 -99999 -99999 -99999 // turns on both forced refinement and cooling refinement
    MustRefineRegionMinRefinementLevel  = 9
    MustRefineRegionLeftEdge   = 0.495391 0.494903 0.499969 // take these values from the halo track
    MustRefineRegionRightEdge  = 0.497391 0.496903 0.501969 // take these values from the halo track
    MustRefineRegionTimeType   = 1
    UseCoolingRefineRegion    = 1
    EvolveCoolingRefineRegion = 1
    CoolingRefineRegionLeftEdge   = 0.495391 0.494903 0.499969 // take these values from the halo track
    CoolingRefineRegionRightEdge  = 0.497391 0.496903 0.501969 // take these values from the halo track
    CoolingRefineRegionTimeType   = 1
    MustRefineRegionFile = halo_track
    CoolingRefineRegionFile = halo_track
    H2StarMakerUseLocalDensityMax      = 1  // turn on using density local max for star maker
    CosmologyFinalRedshift      = 0
    dtDataDump                = 0.25  // finer time spacing

Now this can be submitted to run until it reaches z = 0!